{% extends "base.html" %}
{% load wagtailcore_tags static wagtailsettings_tags %}
{% get_settings %}


{% block content %}

{# HERO ‚Äì Fade in #}

{% include "partials/hero.html" with page=page hero_title=page.title hero_intro=page.intro %}

{# CALLBACK-SEKTION ‚Äì Scale-in animation #}
<section class="py-16 bg-gradient-primary">
    <div class="container mx-auto px-4">
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8 md:p-12 opacity-0 animate-scale-in" style="animation-delay: 400ms">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-slow">
                    <i data-lucide="phone-call" class="w-8 h-8 text-primary-800"></i>
                </div>
                <h2 class="text-3xl font-bold text-primary-800 mb-3">
                    Vill du bli uppringd?
                </h2>
                <p class="text-gray-600">
                    L√§mna dina uppgifter s√• ringer vi upp dig inom 24 timmar.
                </p>
            </div>
            
            <form 
                hx-post="/api/callback-request/" 
                hx-target="#callback-response"
                hx-swap="innerHTML"
                class="space-y-6"
            >
                {% csrf_token %}
                
                <!-- Namn -->
                <div class="form-group">
                    <label for="callback-name" class="form-label">
                        <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                        Namn *
                    </label>
                    <input 
                        type="text" 
                        id="callback-name"
                        name="name"
                        required
                        class="form-input transform transition-all duration-300 focus:scale-105"
                        placeholder="Ditt fullst√§ndiga namn"
                    >
                </div>
                
                <!-- Telefon -->
                <div class="form-group">
                    <label for="callback-phone" class="form-label">
                        <i data-lucide="phone" class="w-4 h-4 inline mr-1"></i>
                        Telefonnummer *
                    </label>
                    <input 
                        type="tel" 
                        id="callback-phone"
                        name="phone"
                        required
                        class="form-input transform transition-all duration-300 focus:scale-105"
                        placeholder="070-123 45 67"
                        pattern="[0-9\s\-\+]+"
                    >
                </div>
                
                <!-- Email (optional) -->
                <div class="form-group">
                    <label for="callback-email" class="form-label">
                        <i data-lucide="mail" class="w-4 h-4 inline mr-1"></i>
                        E-post (valfritt)
                    </label>
                    <input 
                        type="email" 
                        id="callback-email"
                        name="email"
                        class="form-input transform transition-all duration-300 focus:scale-105"
                        placeholder="din@email.se"
                    >
                </div>
                
                <!-- B√§sta tid -->
                <div class="form-group">
                    <label for="callback-time" class="form-label">
                        <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
                        B√§sta tid att ringa
                    </label>
                    <select 
                        id="callback-time"
                        name="preferred_time"
                        class="form-input transform transition-all duration-300 focus:scale-105"
                    >
                        <option value="">V√§lj tid...</option>
                        <option value="morning">F√∂rmiddag (08:00-12:00)</option>
                        <option value="afternoon">Eftermiddag (12:00-17:00)</option>
                        <option value="anytime">Spelar ingen roll</option>
                    </select>
                </div>
                
                <!-- Meddelande -->
                <div class="form-group">
                    <label for="callback-message" class="form-label">
                        <i data-lucide="message-square" class="w-4 h-4 inline mr-1"></i>
                        Vad g√§ller det? (valfritt)
                    </label>
                    <textarea 
                        id="callback-message"
                        name="message"
                        rows="4"
                        class="form-input resize-none transform transition-all duration-300 focus:scale-105"
                        placeholder="Ber√§tta kort vad du beh√∂ver hj√§lp med..."
                    ></textarea>
                </div>
                
                <!-- Submit Button -->
                <div>
                    <button 
                        type="submit"
                        class="btn-primary w-full text-lg py-4 flex items-center justify-center gap-2 hover:scale-105 transition-transform duration-300"
                    >
                        <i data-lucide="phone-outgoing" class="w-5 h-5"></i>
                        Skicka f√∂rfr√•gan
                    </button>
                </div>
                
                <!-- Response Message -->
                <div id="callback-response" class="mt-4"></div>
                
                <!-- GDPR Notice -->
                <p class="text-xs text-gray-500 text-center">
                    Genom att skicka formul√§ret godk√§nner du att vi kontaktar dig.
                    Vi hanterar dina uppgifter enligt 
                    <a href="{% slugurl 'integritetspolicy' %}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-primary-800 underline">
                        v√•r integritetspolicy
                    </a>
                </p>
            </form>
        </div>
    </div>
</section>

{# KONTAKT + INFO ‚Äì Scroll-triggered #}
<section class="py-16 bg-white">
    <div class="container mx-auto px-4">
        <div class="grid lg:grid-cols-2 gap-12 max-w-6xl mx-auto">
            
            <!-- Kontaktformul√§r - Slide fr√•n v√§nster -->
            <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all opacity-0" data-scroll>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary-600 to-primary-800 rounded-xl flex items-center justify-center shadow-md">
                        <i data-lucide="send" class="w-6 h-6 text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-primary-800">Skicka ett meddelande</h2>
                </div>
                
                <form hx-post="{% url 'contact_submit' %}"
                      hx-swap="innerHTML"
                      hx-target="#form-response"
                      class="space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="page_id" value="{{ page.id }}">
                    
                    <!-- Namn -->
                    <div class="form-group">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">
                            <span class="flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4 text-primary-600"></i>
                                Namn *
                            </span>
                        </label>
                        <input type="text" 
                               name="name" 
                               required
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all outline-none transform focus:scale-105"
                               placeholder="Ditt namn">
                    </div>
                    
                    <!-- E-post -->
                    <div class="form-group">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">
                            <span class="flex items-center gap-2">
                                <i data-lucide="mail" class="w-4 h-4 text-accent-600"></i>
                                E-post *
                            </span>
                        </label>
                        <input type="email" 
                               name="email" 
                               required
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-accent-600 focus:ring-4 focus:ring-accent-100 transition-all outline-none transform focus:scale-105"
                               placeholder="din@email.se">
                    </div>
                    
                    <!-- Telefon -->
                    <div class="form-group">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">
                            <span class="flex items-center gap-2">
                                <i data-lucide="phone" class="w-4 h-4 text-accent-600"></i>
                                Telefon
                            </span>
                        </label>
                        <input type="tel" 
                               name="phone"
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-accent-600 focus:ring-4 focus:ring-accent-100 transition-all outline-none transform focus:scale-105"
                               placeholder="070-123 45 67">
                    </div>
                    
                    <!-- √Ñmne -->
                    <div class="form-group">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">
                            <span class="flex items-center gap-2">
                                <i data-lucide="tag" class="w-4 h-4 text-primary-600"></i>
                                √Ñmne
                            </span>
                        </label>
                        <input type="text" 
                               name="subject"
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all outline-none transform focus:scale-105"
                               placeholder="Vad g√§ller din f√∂rfr√•gan?">
                    </div>
                    
                    <!-- Meddelande -->
                    <div class="form-group">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">
                            <span class="flex items-center gap-2">
                                <i data-lucide="message-square" class="w-4 h-4 text-accent-600"></i>
                                Meddelande *
                            </span>
                        </label>
                        <textarea name="message" 
                                  rows="5" 
                                  required
                                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all outline-none resize-none transform focus:scale-105"
                                  placeholder="Ber√§tta mer om hur vi kan hj√§lpa dig..."></textarea>
                    </div>
                    
                    <!-- GDPR-checkbox -->
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <input type="checkbox" 
                               name="gdpr_consent" 
                               required
                               id="gdpr-checkbox"
                               class="w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500 mt-0.5">
                        <label for="gdpr-checkbox" class="text-sm text-gray-700 leading-relaxed">
                            {{ page.gdpr_text|striptags }}
                        </label>
                    </div>
                    
                    <!-- Skicka-knapp -->
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-primary-700 to-primary-500 hover:from-primary-800 hover:to-primary-600 text-white font-semibold px-8 py-4 rounded-lg transition-all shadow-lg hover:shadow-glow-primary transform hover:scale-[1.02] group">
                        <span class="flex items-center justify-center gap-2">
                            Skicka meddelande
                            <i data-lucide="send" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                        </span>
                    </button>
                    
                    <!-- Response message -->
                    <div id="form-response" class="mt-4"></div>
                </form>
            </div>
            
            <!-- Kontaktinfo + Portal - Slide fr√•n h√∂ger -->
            <div class="space-y-8 opacity-0" data-scroll style="animation-delay: 200ms">
                <!-- Kontaktinformation -->
                <div class="bg-gradient-to-br from-primary-700 to-primary-500 text-white rounded-2xl p-8 shadow-xl relative overflow-hidden transform transition-all duration-500 hover:scale-105">
                    <!-- Dekor -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-16 -mt-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-5 rounded-full -ml-12 -mb-12"></div>
                    
                    <div class="relative z-10">
                        <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i data-lucide="info" class="w-6 h-6"></i>
                            Kontaktinformation
                        </h3>
                        
                        <div class="space-y-6">
                            {% if page.address %}
                            <div class="flex items-start gap-4 group">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                                    <i data-lucide="map-pin" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-1">Adress</h4>
                                    <p class="text-white/90 leading-relaxed">{{ page.address|linebreaks }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if page.phone %}
                            <div class="flex items-start gap-4 group">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                                    <i data-lucide="phone" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-1">Telefon</h4>
                                    <a href="tel:{{ page.phone }}" class="text-white/90 hover:text-white transition underline">
                                        {{ page.phone }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if page.email %}
                            <div class="flex items-start gap-4 group">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                                    <i data-lucide="mail" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-1">E-post</h4>
                                    <a href="mailto:{{ page.email }}" class="text-white/90 hover:text-white transition underline">
                                        {{ page.email }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if page.opening_hours %}
                            <div class="flex items-start gap-4 group">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                                    <i data-lucide="clock" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-1">√ñppettider</h4>
                                    <div class="text-white/90">{{ page.opening_hours|richtext }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Kundportal CTA -->
                <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-8 border-2 border-gray-200 hover:border-primary-300 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-accent-500 to-accent-600 rounded-xl flex items-center justify-center shadow-md">
                            <i data-lucide="log-in" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">Redan kund?</h3>
                    </div>
                    <p class="text-gray-600 mb-6 leading-relaxed">
                        Logga in p√• v√•r kundportal f√∂r att hantera dina √§renden, ladda upp dokument och kommunicera med oss.
                    </p>
                    {% with portal_url=settings.core.NavigationSettings.portal_url|default:"https://harpans.konfident.io" %}
                    <a href="{{ portal_url }}" 
                       target="_blank"
                       rel="noopener noreferrer"
                       class="inline-flex items-center justify-center w-full bg-gradient-to-r from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 text-white font-semibold px-6 py-3 rounded-lg transition-all shadow-lg hover:shadow-glow-accent transform hover:scale-[1.02] group">
                        <span>Till kundportalen</span>
                        <i data-lucide="external-link" class="w-5 h-5 ml-2 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
                    </a>
                    {% endwith %}
                </div>
                
                <!-- Snabbval: ring / maila -->
                <div class="grid grid-cols-2 gap-4">
                    {% if page.phone %}
                    <a href="tel:{{ page.phone }}" 
                       class="flex flex-col items-center gap-3 p-6 bg-white border-2 border-gray-200 rounded-xl hover:border-primary-300 hover:shadow-lg hover:-translate-y-1 transition-all group">
                        <div class="w-12 h-12 bg-gradient-to-br from-primary-600 to-primary-700 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="phone" class="w-6 h-6 text-white"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-700 group-hover:text-primary-600 transition">Ring oss</span>
                    </a>
                    {% endif %}
                    
                    {% if page.email %}
                    <a href="mailto:{{ page.email }}" 
                       class="flex flex-col items-center gap-3 p-6 bg-white border-2 border-gray-200 rounded-xl hover:border-accent-300 hover:shadow-lg hover:-translate-y-1 transition-all group">
                        <div class="w-12 h-12 bg-gradient-to-br from-accent-500 to-accent-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-700 group-hover:text-accent-600 transition">Maila oss</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

{# Trust badges - Stagger #}
<section class="py-16 bg-gradient-to-b from-white to-gray-50">
    <div class="container mx-auto px-4 max-w-4xl text-center opacity-0" data-scroll>
        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-primary-800">
            Vi svarar snabbt!
        </h2>
        <p class="text-gray-600 text-lg mb-8">
            Vi √•terkommer vanligtvis inom 24 timmar p√• vardagar. <br class="hidden md:block">
            Akuta fr√•gor? Ring oss direkt.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
            <div class="flex items-center gap-2 px-6 py-3 bg-primary-50 rounded-full transform hover:scale-110 transition-transform duration-300">
                <i data-lucide="clock" class="w-5 h-5 text-primary-600"></i>
                <span class="text-sm font-semibold text-gray-700">Svar inom 24h</span>
            </div>
            <div class="flex items-center gap-2 px-6 py-3 bg-accent-50 rounded-full transform hover:scale-110 transition-transform duration-300">
                <i data-lucide="shield-check" class="w-5 h-5 text-accent-600"></i>
                <span class="text-sm font-semibold text-gray-700">GDPR-s√§kert</span>
            </div>
            <div class="flex items-center gap-2 px-6 py-3 bg-white border border-accent-200 rounded-full transform hover:scale-110 transition-transform duration-300">
                <i data-lucide="zap" class="w-5 h-5 text-primary-700"></i>
                <span class="text-sm font-semibold text-gray-700">Gratis konsultation</span>
            </div>
        </div>
    </div>
</section>

<!-- Confetti container -->
<div id="confetti-container" class="confetti-container"></div>

<style>
/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.animate-fade-in-up {
    animation: fadeInUp 0.8s ease-out forwards;
}

.animate-scale-in {
    animation: scaleIn 0.8s ease-out forwards;
}

.animate-fade-in {
    animation: fadeIn 0.8s ease-out forwards;
}

.animate-bounce-slow {
    animation: bounce 2s infinite;
}

/* Scroll-triggered */
[data-scroll] {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
}

[data-scroll].visible {
    opacity: 1;
    transform: translateY(0);
}

/* Form animations */
@keyframes fadeInAnim {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
    
.animate-fade-in {
    animation: fadeInAnim 0.3s ease-out;
}

@keyframes errorShake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-4px); }
    40%, 80% { transform: translateX(4px); }
}

.error-shake {
    animation: errorShake 0.25s ease-in-out;
}
</style>

<script>
    lucide.createIcons();
    
    // Scroll-triggered animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, observerOptions);

    document.querySelectorAll('[data-scroll]').forEach(el => {
        observer.observe(el);
    });
    
    // ‚ú® CONFETTI FUNCTION ‚ú®
    function createConfetti() {
        const container = document.getElementById('confetti-container');
        if (!container) return;
        
        const colors = ['#4a0416', '#c2185b', '#7c2d41', '#f8bbd0', '#ffd54f', '#81c784'];
        const confettiCount = 100;
        
        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            
            container.appendChild(confetti);
            
            // Remove after animation
            setTimeout(() => {
                confetti.remove();
            }, 3500);
        }
    }
    
    // HTMX success handler WITH CONFETTI!
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        const targetEl = evt.detail.target;
        if (!targetEl || targetEl.id !== 'form-response') {
            return;
        }

        const responseDiv = document.getElementById('form-response');
        if (!responseDiv) return;

        if (evt.detail.successful) {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                if (response.success) {
                    responseDiv.innerHTML = 
                        '<div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 text-green-800 px-6 py-4 rounded-xl shadow-lg animate-fade-in">' +
                        '<div class="flex items-center gap-3">' +
                        '<i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>' +
                        '<p class="font-semibold">' + response.message + '</p>' +
                        '</div>' +
                        '</div>';
                    evt.detail.target.closest('form').reset();
                    lucide.createIcons();

                    // üéâ TRIGGER CONFETTI! üéâ
                    createConfetti();
                }
            } catch (e) {}
        } else {
            responseDiv.innerHTML = 
                '<div class="bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-300 text-red-800 px-6 py-4 rounded-xl shadow-lg animate-fade-in error-shake">' +
                '<div class="flex items-center gap-3">' +
                '<i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>' +
                '<p class="font-semibold">Ett fel uppstod. F√∂rs√∂k igen.</p>' +
                '</div>' +
                '</div>';
            lucide.createIcons();
        }
    });

    // Re-init icons
    document.body.addEventListener('htmx:afterSwap', function() {
        lucide.createIcons();
    });
</script>

{% endblock %}